echo "üõ°Ô∏è  Running Security Scans (Pre-Push)..."

# 1. Semgrep SAST
if command -v semgrep >/dev/null 2>&1; then
  echo "üîç Running Semgrep (SAST)..."
  bun run security:semgrep
  if [ $? -ne 0 ]; then
    echo "‚ùå Semgrep found security issues! Please fix them before pushing."
    exit 1
  fi
else
  echo "‚ö†Ô∏è  Semgrep not found in PATH. Skipping SAST scan. (Install via 'brew install semgrep')"
fi

# 2. Snyk Code SAST
# Check if user is authenticated with Snyk (token exists in config or env)
SNYK_API_CONFIG=$(bunx snyk config get api 2>/dev/null || echo "")
if [ -n "$SNYK_TOKEN" ] || [ -n "$SNYK_API_CONFIG" ]; then
    echo "üê∂ Running Snyk Code..."
    bun run security:snyk
    if [ $? -ne 0 ]; then
      echo "‚ùå Snyk found critical vulnerabilities! Please fix them before pushing."
      exit 1
    fi
else
    echo "‚ö†Ô∏è  Snyk is not authenticated. Skipping Snyk scan. (Run 'snyk auth' to enable)"
fi

echo "‚úÖ Security checks passed!"
